---
layout: default
---

# EntityManager

## EntityManagerã¨ã¯ï¼Ÿ

EntityManagerã€€ã¯ã€
**JPAã§DBæ“ä½œã‚’è¡Œã†ãŸã‚ã®ä¸­å¿ƒçš„ãªå­˜åœ¨**ã€‚

Entityã‚’ç›´æ¥DBã«ä¿å­˜ãƒ»å–å¾—ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¦ã€
å®Ÿéš›ã«ã¯ **EntityManager ã‚’é€šã—ã¦æ“ä½œ**ã€€ã—ã¦ã„ã‚‹ã€‚

---

## JPAå…¨ä½“ã®ä¸­ã§ã®å½¹å‰²

- Entity
    â†’ã€€æ°¸ç¶šåŒ–ã•ã‚Œã‚‹å¯¾è±¡
- EntityManager
    â†’ã€€Entityã‚’æ“ä½œã™ã‚‹çª“å£
- æ°¸ç¶šåŒ–ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
    â†’ã€€Entityã®ç®¡ç†é ˜åŸŸ

EntityManagerã€€ã¯
**æ°¸ç¶šåŒ–ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ“ä½œã™ã‚‹ãŸã‚ã®API**ã¨ã‚‚è¨€ãˆã‚‹ã¨æ€ã†ã€‚

---

## ä¸»ãªå½¹å‰²

- Entityã®æ°¸ç¶šåŒ–ï¼ˆä¿å­˜ï¼‰
- Entityã®æ¤œç´¢ï¼ˆå–å¾—ï¼‰
- Entityã®æ›´æ–°
- Entityã®å‰Šé™¤
- æ°¸ç¶šåŒ–ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ç®¡ç†

---

## ä¸»ãªãƒ¡ã‚½ãƒƒãƒ‰

| ãƒ¡ã‚½ãƒƒãƒ‰ | å†…å®¹ |
| --------- | ---- |
| persist | æ–°è¦Entityã‚’æ°¸ç¶šåŒ– |
| find | ä¸»ã‚­ãƒ¼ã§Entityã‚’å–å¾— |
| merge | Entityã®çŠ¶æ…‹ã‚’æ›´æ–° |
| remove | Entityã‚’å‰Šé™¤ |
| flush | SQLã‚’å³æ™‚ç™ºè¡Œ |

---

## find ã®ç‰¹å¾´

æ°¸ç¶šåŒ–ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã«EntityãŒå­˜åœ¨ã™ã‚Œã°
â†’ **SQLã¯ç™ºè¡Œã•ã‚Œãªã„**

åŒã˜IDã®Entityã¯
â†’ **å¿…ãšåŒä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãªã‚‹**

```java
User u1 = entityManager.find(User.class, 1L);
User u2 = entityManager.find(User.class, 1L);

// u1 == u2
```

---

## ãªãœåŒä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãªã‚‹ã®ã‹

æ°¸ç¶šåŒ–ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒ
**ã€ŒID â†’ Entityã€ã®å¯¾å¿œé–¢ä¿‚ã‚’ç®¡ç†ã—ã¦ã„ã‚‹**ãŸã‚

ã“ã‚Œã«ã‚ˆã‚Š

- ç„¡é§„ãªSELECTã‚’é˜²ã
- å¤‰æ›´æ¤œçŸ¥ãŒæ­£ã—ãå‹•ã

---

## mergeï¼šEntityã‚’çµ±åˆã™ã‚‹ï¼ˆæ³¨æ„ãŒå¿…è¦ï¼‰

```java
- User detachedUser = new User();
- User managedUser = entityManager.merge(detachedUser);
```

---

## merge ã®æ³¨æ„ç‚¹

æˆ»ã‚Šå€¤ãŒ **managedçŠ¶æ…‹ã®Entity**

å¼•æ•°ã®Entityã¯ **ç®¡ç†ã•ã‚Œãªã„ã¾ã¾**

çŠ¶æ…‹ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸ **åˆ¥ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹** ãŒç®¡ç†å¯¾è±¡ã«ãªã‚‹

```java

detachedUser != managedUser

```

---

## æ³¨æ„ã™ã¹ãç†ç”±

å®‰æ˜“ã«ä½¿ã†ã¨

ã©ã®EntityãŒç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã‹åˆ†ã‹ã‚‰ãªããªã‚‹

æ›´æ–°ç›®çš„ã§ã‚ã‚Œã°
**find â†’ å€¤å¤‰æ›´ï¼ˆå¤‰æ›´æ¤œçŸ¥ï¼‰** ã®æ–¹ãŒå®‰å…¨ã§åˆ†ã‹ã‚Šã‚„ã™ã„

---

## removeï¼šEntityã‚’å‰Šé™¤ã™ã‚‹

```java
entityManager.remove(user);
```

### remove ã®æ³¨æ„ç‚¹

**managedçŠ¶æ…‹ã®Entityã®ã¿** å‰Šé™¤å¯èƒ½

å‘¼ã³å‡ºã—æ™‚ç‚¹ã§ã¯DELETEæ–‡ã¯å³æ™‚ç™ºè¡Œã•ã‚Œãªã„

Entityã¯ **removedçŠ¶æ…‹** ã«ãªã‚Šã€
ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«DELETEæ–‡ãŒç™ºè¡Œã•ã‚Œã‚‹

---

## flushï¼šSQLã‚’å³æ™‚ç™ºè¡Œã™ã‚‹

```java
entityManager.flush();
```

æ°¸ç¶šåŒ–ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å¤‰æ›´å†…å®¹ã‚’DBã«åæ˜ ã™ã‚‹

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è‡ªä½“ã¯çµ‚äº†ã—ãªã„

é€šå¸¸ã®æ¥­å‹™å‡¦ç†ã§ã¯æ˜ç¤ºçš„ã«å‘¼ã¶ã“ã¨ã¯å°‘ãªã„

---

## EntityManagerã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

### åŸºæœ¬ãƒ«ãƒ¼ãƒ«

EntityManagerã®æ“ä½œã¯
**ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§è¡Œã†ã®ãŒå‰æ**

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ã§ã¯

å¤‰æ›´æ¤œçŸ¥ãŒå‹•ã‹ãªã„

æ°¸ç¶šåŒ–ã®ä¿è¨¼ãŒãªã„

---

## Springã§ã®åˆ©ç”¨ä¾‹

```java
@Transactional
public void updateUser() {
    User user = entityManager.find(User.class, 1L);
    user.setName("Taro");
}
```

@Transactional ã«ã‚ˆã‚Š

ãƒ¡ã‚½ãƒƒãƒ‰é–‹å§‹æ™‚ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹

çµ‚äº†æ™‚ã«commit

commitæ™‚ã«å¤‰æ›´æ¤œçŸ¥ãŒå®Ÿè¡Œã•ã‚Œã‚‹

---

## ã‚ˆãã‚ã‚‹å‹˜é•ã„

EntityManager = DBæ¥ç¶š
â†’ âŒ é•ã†ï¼ˆEntityç®¡ç†ã¨æ“ä½œã®çª“å£ï¼‰

merge = æ›´æ–°å°‚ç”¨ãƒ¡ã‚½ãƒƒãƒ‰
â†’ âŒ managedçŠ¶æ…‹ã«ã™ã‚‹ãŸã‚ã®æ“ä½œ

persistã—ãŸã‚‰å³INSERTã•ã‚Œã‚‹
â†’ âŒ ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ä¿è¨¼ã•ã‚Œãªã„

---

## åŸºæœ¬çš„ãªä½¿ã„æ–¹

```java
User user = new User("Taro");
entityManager.persist(user);
```

---

â† [å‰ã¸ï¼šEntity](02_entity.html)  
â†’ [æ¬¡ã¸ï¼šæ°¸ç¶šåŒ–ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆPersistence Context](04_persistence_context.html)

ğŸ  [ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹](index.html)
